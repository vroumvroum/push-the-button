language: java

#Using the default oracleJdk8 proposed by Travis
jdk:
  - oraclejdk8

#We don't need to retrieve all the commits
git:
  depth: 3

#Define here the host and ip of the stage environment
#Secure keys are for SONAR_TOKEN, TOMCAT_MANAGER_LOGIN and TOMCAT_MANAGER_PASSWORD
env:
  global:
    - STAGE_HOST=clickp.stage.env
    - STAGE_IP=88.171.128.121
    - secure: cVA5VriyUReySRsCk850MosmHF4yZF5dUBctkokqH6b5Lp7yUqEj7OtLxzlYDzr+dj0IyyZEKRu/5c+W5DxeLXmh4pAxOGOPnme7QoYLfPpobKphJadC6aJ3Ofx2qnbTOTPax1SQjguvP6SatsayZHsnuDlZjgH7ZBvqF3eGuGH+4Q3AIz9YhR8pRJxs7ogrDz4R3qPwnGlPBR+6JfwhK/zB0Y2fypKAyoKF7EnEjnCYRdKztBjSJYoTTnGuu4+nzSbfqTtloPfedhwT+5+dgmVL1QlCjMgbRxUliYUVhxHCGFFLsQ7kfhFyMK87M7/GepNUd+WIKX/a/39cDeU00M+VZYwmJNz9IRW8aUYbBAGEGYQ+gjFyCXdHLbIPug1HLTEo5lRciue/ghBk+QXMoDz/9LuwjF2/AHLGLyWMS8kvdmvFpRhbptfA8GIYCybYlBdKfpk9qsfT0Hywa4oLaY90ZrBeE4xkGIQGtkx17If6UKzl/b7Qi0EkVKF6IySMT9fz1jwTh6EEIljh+gH1wFVLZfbRhCv2AzYrFlDQPqJb1zfQnkPweNw+tiSlMSOpGLVhtBxbVktG/Bnz15luut/xi6mWvvlBnKK6FbW5v3ruRgSgCLMakWQJGGNJmgzcW/qDRt2bnmj2a6MpVPW9tF4IFIBen85qrtybF4NumOs= 
    - secure: MxOvTfvjs0HrVF0rgKS8vmgOz+nGQaJnwf8SxPhs213Y1/7kw4tbcvuyU/BUowL57lNFO5qowX/yfZRHy27TLKB54Srboa4V6+OQidPj+69NTlNtDGC6DwnCWbS4HAcLWFDnGenSfehhRUNUB4oIEu35+iJW7YEN3vWzfUJMOmqog5b5+RAX5mAYIhdm4oTDQl6KoIhi+nsjJ2updVvz5kxfAUiD+10FiLqsnRAScfGSAxfzULe0CqnCC24l8A9woZPagzKuHtd8365+epUwVTAgBpF89/5Vsd7U65VAKWwCCyi+YXqh7oMf6+Hn65oO7hm9U8wTQDexXt0/M8ruoKL2OiXleo8F/tTCVs7b8PyqfY/DEDRauv72i+jPqZACAHk2FI7R9vfaMAjqNkm3ZKVxj/AkjTF12Aq7IhWN56OnoXZA1Qsejg07DExl9VaXsamo6wkwo2aKZSyA3iWdE78vvGPt3ypk/hb/nPAbZCYJXQ4PL0NtmrvLjPBXtYUyKUWAeSXrq5ym5wpd37Q8QAo8BwPxVxDxOSnXoCMTOvPV7eXLBdjW7j5lBtjTNTsAM4oDznojYAHctMV/DLvmZEqomDUCqtsyP2IBpM3cPklxu9QJY7Lh0cTn5gMCRtxyc9ypBANPHl7UUFjHershgPryxEvn6vuB10h6uWU4iu0= 
    - secure: fR4VPT0imrx+yscLL55w+oeD+hEtbV5d8+2/BGjCfIxJdLZ9MsHMB27Dr/eHUV5hP+y6si+AMEO/3ttd47+DGGYLgBjlyUNeWz+Jkca/nGzJieVTMFsMQlvRNSVT8UqxZHnIwVmV2jN+1Qp+xWF1AmxiBAjzzruBUW+80b1DGIdlnz9c6CPiz+oTEjXSS/m3dVuEKYir4wCsSSr0PDR0B3wYsilcxQefBo6mqx4VLyBP7BoT7nq+0LJgeAJR11DnBJRg8gYEYFZKsbTbx7p5K+JJsrlgqTIKmuMaF9oo4dp/JwZjep9xuXOwhSonL+PB8Gf9w49+3mNIXSrW4NTg1Tm82uNlAjoiif7vZdPU9qVNG3fDmg1S/B34kYTcGeIYsedupaV73W0Z7IYjhvVmYK5Ih9MQiwqc8GVhryDlbv5pFVA6OWtKva1DCokSwMiSa5l7r7c5qEkEESgLnsqUslB8zwb2T5aNIiNDUWcgEoykvM+fByCoop/NOO03t/vCUkejcAfktc70r0lm8R9by9AfCuIzW24+kmcnOx8YC6fznrGgG4/M/TWnAbJvvYiVEjJ1oDnouYS0wuv6Ma2ySWsWL0ZwWuy5+le0R7t+L3IMCpBU2c3TOkEE9TpYH3bdL+86TFDGGaDBZfPmAHmXGwJmk9Iancwaqti11sDPdLE= 

#Adding stage host to /etc/hosts
before_install:
  - sudo sh -c 'echo "\n\n${STAGE_IP} ${STAGE_HOST}" >> /etc/hosts'
  - cat /etc/hosts

#Skipping install phase
install: true

#Caching Maven and Sonar work directory to speed up the build
cache:
  directories:
  - "$HOME/.m2"
  - "$HOME/.sonar/cache"

#Activating sonarqube addon (Cf. script phase)
addons:
  sonarqube: true

#Defining how to build. For stage environment, we want to make a quality check also
script:
   - mvn clean package

# We are on the staging branch, so we deploy the application automatically after a successfull build
after_success:
  - mvn tomcat7:redeploy || mvn tomcat7:deploy
  - curl http://clickp.stage.env:8080/clickcount/rest/healthcheck
  - mvn clean -X org.jacoco:jacoco-maven-plugin:prepare-agent sonar:sonar -Dsonar.login=$SONAR_TOKEN -Dsonar.projectKey="push-the-button-${TRAVIS_BRANCH}"
